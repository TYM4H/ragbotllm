# Реализованный функционал проекта

## I. Общая архитектура

- Проект построен по модульной структуре:
  - **bot/** — Telegram-бот на базе библиотеки `aiogram`;
  - **rag/** — основной RAG-модуль, включающий индексацию, поиск и работу с эмбеддингами;
  - **main.py** — backend на `FastAPI`, обрабатывающий запросы от бота;
  - **chroma_db/** — локальное векторное хранилище на основе `ChromaDB`.

- Общая схема взаимодействия компонентов:
  - Telegram-бот → FastAPI backend → Ollama + ChromaDB.

---

## II. Обработка и хранение данных

- Используется база данных `ChromaDB` в режиме `PersistentClient` для постоянного хранения эмбеддингов.  
- Для каждого пользователя создаётся отдельная коллекция `user_<id>`.  
- В коллекции сохраняются:
  - идентификаторы документов;
  - векторные представления текста (эмбеддинги);
  - очищенные текстовые данные;
  - метаданные (источник документа, тип файла и т.д.).

---

## III. Извлечение и очистка текста

- Извлечение текста из PDF реализовано с использованием библиотеки `pypdf`.  
- Предобработка текста выполняется функцией `clean_text()` из модуля `rag/utils.py`.  
- Очистка включает:
  - удаление лишних пробелов и мусорных символов;
  - сохранение математических и технических знаков (`=`, `+`, `-`, `/`, `*`, `%`, `°`);
  - возвращение текста, готового к векторизации.

---

## IV. Модели и генерация эмбеддингов

- Векторизация текста выполняется локальной моделью **Ollama**.  
- Используемые модели:
  - для эмбеддингов — `nomic-embed-text`;
  - для генерации ответов — `llama3`.  
- Все запросы к Ollama реализованы синхронно через библиотеку `requests`.  
- Функция `embed_text` отвечает за получение эмбеддингов для текста и возвращает числовой вектор.

---

## V. Индексация документов

- Реализована функция `ingest_pdf`, выполняющая:
  - приём PDF-файла в виде байтового потока;
  - временное сохранение файла;
  - извлечение и очистку текста;
  - генерацию одного эмбеддинга для всего документа;
  - добавление данных в ChromaDB в виде одного элемента.  
- Индексация выполняется без чанкинга и асинхронных операций.

---

## VI. Поиск и генерация ответа

- Реализована функция `query_rag`, выполняющая:
  - получение эмбеддинга вопроса пользователя;
  - поиск ближайшего документа в коллекции пользователя по векторному сходству;
  - формирование промпта с найденным контекстом и вопросом;
  - генерацию ответа через модель `llama3` в Ollama.  
- Формат ответов: модель формулирует краткий ответ на русском языке или сообщает об отсутствии информации.

---

## VII. Backend (FastAPI)

- Реализованы два основных эндпоинта:
  - `POST /ingest` — загрузка и индексация PDF-документа;
  - `POST /query` — получение ответа на вопрос пользователя.  
- Все операции выполняются синхронно, без использования `asyncio`.  
- FastAPI автоматически управляет потоками, что исключает блокировку основного процесса.

---

## VIII. Telegram-бот

- Бот реализован на библиотеке `aiogram`.  
- Основной функционал:
  - команда `/start` — приветственное сообщение;
  - загрузка PDF-документов и их передача в backend через API;
  - отправка текстовых сообщений с вопросами к документам;
  - получение и отображение ответов от backend.  
- Взаимодействие с backend осуществляется через библиотеку `aiohttp`.

---

## IX. Настройка и конфигурация

- Переменные окружения хранятся в файле `.env`:
  - `TELEGRAM_BOT_TOKEN` — токен Telegram-бота.  
- Путь к хранилищу ChromaDB задан статически (`./chroma_db`).  
- Все зависимости перечислены в `requirements.txt`:
  - `fastapi`, `uvicorn`, `aiogram`, `aiohttp`, `chromadb`, `pypdf`, `python-dotenv`, `requests`.

---

## X. Итоговое состояние

- Поддерживается полный цикл работы:
  1. Пользователь отправляет PDF через Telegram-бота.  
  2. Backend индексирует документ и сохраняет его в ChromaDB.  
  3. Пользователь задаёт вопрос по содержимому документа.  
  4. Система находит соответствующий документ и формирует ответ.  
- Архитектура проста, надёжна и готова к дальнейшему масштабированию и добавлению новых функций.

# ToDO

## I. Архитектура и хранение данных

- Добавить хранение метаданных о документах (имя файла, дата загрузки, количество страниц, длина текста).  
- Внедрить проверку хэша загружаемого PDF для предотвращения повторной индексации идентичных файлов.  

---

## II. Обработка текста и эмбеддинги

- Реализовать безопасное разбиение документа на крупные фрагменты при превышении лимита контекста модели.  
- Добавить кэширование эмбеддингов для исключения повторных обращений к Ollama при одинаковом тексте.  
- Обеспечить поддержку выбора модели для эмбеддингов и генерации ответов (через настройки или переменные окружения).

---

## III. Backend и API

- Реализовать обработку исключений и возвращение корректных кодов HTTP-ответов (`400`, `404`, `500`).  
- Добавить API-методы для управления документами:
  - `GET /list_docs` — получение списка документов пользователя;  
  - `DELETE /doc/{id}` — удаление выбранного документа;  
  - `DELETE /reset/{user_id}` — очистка коллекции пользователя.  
- Добавить простую авторизацию через API-ключ, определяемый в файле `.env`.  

---

## IV. Telegram-бот

- Внедрить управление состояниями пользователя (FSM) для разделения сценариев загрузки и запросов.  
- Реализовать уведомления о ходе индексации документа (сообщения «Идёт обработка…» / «Готово»).  
- Добавить команды:  
  - `/docs` — список загруженных документов;  
  - `/delete <имя>` — удаление документа;  
  - `/reset` — очистка коллекции;  
  - `/help` — справка по использованию.  

---

## V. Производительность и устойчивость

- Вынести индексацию PDF в отдельный поток или процесс для предотвращения блокировки FastAPI.
- Ввести ограничение на количество одновременных запросов к Ollama и реализацию очереди задач.
- Перейти на на какой то другой pdf конвертер для повышения точности извлечения текста из PDF-документов.  

---

## VI. Деплой и эксплуатация

- Подготовить `Dockerfile` и `docker-compose.yml` для сборки и запуска следующих сервисов:  
  - `backend` (FastAPI);  
  - `ollama`;  
  - `chroma`.  
- Добавить систему логирования (ротация логов, вывод в файл).  
- Реализовать сбор базовых метрик производительности и обращений (через middleware FastAPI).  
